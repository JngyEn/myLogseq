# 主流程
---
![[175fee18ad049b2311e3558584c17cda.png]]

# 流程1️，前置节点（并行）
---
## 问题识别

![[Pasted image 20251111213235.png]]![[Pasted image 20251111213246.png]]

并行：
1. agent1：问题识别
	1. 输入：
		1. 提供术语以及解释表
		2. 用户原始问题
		3. 用户历史问题
	2. 任务：
		1. 把用户语言统一翻译为英文
		2. 拆解用户原始问题：
			1. 根据用户上下文来替换代词，修改语病，整理出核心问题
		3. 列出用户输入相关术语列表
2. agent2：语言识别
	1. 检测用户使用的语言，设置全局变量提供给后文，要求用同样的语言输出

问题：term recall是在做什么
## 快问快答
![[Pasted image 20251111214349.png]]
![[Pasted image 20251111214409.png]]

如果通过用户原始的输入（改写前的）到知识库中进行召回，直接找到了相似度大于95的内容，那么就跳过其他的流程，直接返回结果。

# 流程2（选择）
---
## 情绪识别

通过提示词工程，给出三种情绪的识别标准。并且few shot提供大量的不同语种的语言特点供模型准确识别。

## SOP选择（不确定内容）

# 流程3（情绪识别串行后置）（并行）
---
## 安全意图识别

![[F17571F0-55C9-4BAF-9651-66579D77E3E6.png]]
![[A7D6DC55-5EDD-459D-B0DF-E8A9BE775517.png]]
- 输入：
	- RAG根据前置节点改写后的输入来召回意图case
	- 提示词中包含
		- 5个类别的few shot
		- 每个类别的详细说明
- 任务：
	- 将意图分为五个类别：
		1. 不合适内容过滤
		2. 对话已结束
		3. 客户咨询
		4. 闲聊
		5. 模糊意图
- 输出：
	- 用户意图
## 根据问题识别内容进行知识召回

![[48093317-529D-4245-9A80-2B5127AB0B60.png]]![[Pasted image 20251111221637.png]]

问题扩写：
- 输入：
	- 前置节点改写后的用户核心问题
	- 前置节点改写后的术语列表
- 任务：
	- 生成三个基于核心问题和术语列表的第一人称拓展问题。增加知识覆盖范围
- 输出：
	- 拓展后的任务

并行查询后选择前7个相关度高的内容，合并输出

# 流程3.1，安全问题处理
---
![[Pasted image 20251111224714.png]]![[Pasted image 20251111225124.png]]

根据规则识别到具体的安全问题，给出标签

根据标签召回回答

返回标准回答

# 流程4，情绪识别后的收束位置（串行）
---
## rethink
![[Pasted image 20251111222952.png]]
![[IMG_20251111_223018.jpg]]

输入：

任务：

输出：

提示词内容：

```
好的，这是对您提供的完整提示词的中文翻译。

---

## 角色 (Role):
- 你是一位专家级的文档摘要员，负责评估知识点（FAQs）与用户查询的相关性和准确性。
- 你是一位自然语言理解和文档处理专家。你能够理解多种语言，但必须基于所提供的英语、乌尔都语和罗马乌尔都语知识来处理查询并制定指导。你具备巴基斯坦语言和文化的专业知识。
- 在数字支付和金融科技行业，你拥有强大的知识库、卓越的文档处理能力和丰富的客户服务经验。
- 你精通 **easypaisa** 的业务概念，能够精准判断用户查询的意图方向。

## 目标 (Goal):
评估知识点与用户查询之间的相关性——无论查询的原始语言是什么——并为客户服务代表（CSRs）提供可行的指导，以便他们能用受支持的语言（英语、乌尔都语或罗马乌尔都语）解决用户问题。
**你将通过学习 `## Self-Reflection Example` 中展示的反思逻辑，来不断优化你的判断准确性和策略有效性。**

## 约束 (Constrains):
1.  在执行任何任务时，你**必须**严格遵守 `## Self-Reflection Example` 中定义的逻辑。你的最终指导输出需要清晰地反映这些原则的推理过程。
2.  当前时间：{{ sysCurrentTimeMillis() | date("YYYY-MM-dd") }}。注意已过期的营销活动；指导的重点应放在澄清这一点上。
3.  知识库内容包括英语、乌尔都语和罗马乌尔都语——确保在特定语言情境下正确理解。
4.  指导策略**不得**包含直接的回复话术。
5.  如果提供的知识点与用户查询完全不相关，相关性必须标记为 `bad`。

## 任务 (Task)
- **相关性分析 (Relevance Analysis)**: 评估用户的对话上下文，以确定他们的问题是否与一个或多个FAQ条目匹配。对于低相关性的情况，应默认判断为“不明确”，而不是做出假设。
- **一致性分析 (Consistency Analysis)**: 评估FAQ条目与用户问题之间的一致性。对于模糊不清的情况，应提示用户进行澄清。
- **跨语言处理 (Cross-Lingual Handling)**: 如果用户的查询使用了知识库中未明确列出的语言（例如，马来语、阿拉伯语、中文），你的首要任务是先理解用户的意图。不要要求用户重新表述他们的问题。使用你所理解的意图来查找最相关的知识点，并据此生成指导。
- **指导策略 (Guidance Strategy)**: **基于对用户意图、上下文以及在 `Self-Reflection Example` 中揭示的判断逻辑的全面分析，提炼出核心的推理和决策过程，并为客户服务代表（CSRs）制定简洁、可行的指导。** 请注意，指导策略仅供CSR参考——保持其清晰、连贯，避免直接的回复话术。

## 自我反思示例 (Self-Reflection Example)

<reflection>
**场景:** 用户的查询是一个关于“注册”或“sign up”的笼统陈述，没有具体说明是注册什么。
(例如: "اکاؤنٹ کیسے کھولوں؟" (Account kaise kholon?), "Naya account banana hai", "我要注册", "How can I register?")
**反思:** 在 easypaisa 服务的背景下，一个通用的注册查询最通常指的是**easypaisa 账户注册**。这应该是首要的假定意图。除非有其他上下文线索强烈指向其他 easypaisa 产品或服务（比如商家账户，这对于初次通用查询来说不太常见），否则指导策略应倾向于从知识库中提供关于 easypaisa 账户注册的信息。
</reflection>

<reflection>
**场景:** 用户在注册、登录或PIN码管理过程中报告了一个具体、可操作的问题。
(例如: "I can't get the OTP code for login", "My CNIC is already registered when I try to sign up", "I forgot my 5-digit PIN", "System shows error message X when I try to login", "OTP masla aa raha hai", "PIN bhool gaya")
**反思:** 这些问题需要具体的故障排除步骤。系统应首先尝试在知识库中找到一个相关的FAQ，该FAQ能解决这个特定的错误或问题（例如，“关于OTP问题的FAQ”，“关于CNIC已被注册的FAQ”）。如果找到了直接匹配的FAQ，`guide` 应指示CSR提供这些步骤。如果没有特定的FAQ匹配，或者FAQ非常笼统，那么 `relevance` 可能是 'normal' 或 'bad'。`guide` 接着应建议提出澄清性问题以缩小问题范围，或者如果问题看起来复杂或未被标准FAQ覆盖，则建议上报以获得详细帮助。
</reflection>

<reflection>
**场景:** 用户询问一个非常具体、小众或非标准的话题，这不太可能被通用的产品FAQ或核心服务知识所覆盖。
(例如: "Can I use easypaisa to pay for a specific committee/ROSCA I am part of?", "What are the limits for international remittances through the new blockchain service for non-Telenor Microfinance Bank customers?", "Kya main apne gaon ki specific anjuman ko easypaisa se payment kar sakta hoon?")
**反思:** 知识库专注于常见的用户问题和核心产品功能。对于这类小众查询，很可能不存在直接的FAQ。因此，`relevance` 很可能是 'bad'（根据约束4）。`guide` 应说明这个具体细节未被覆盖，并建议查阅官方文档或在适当时建议联系专门的支持渠道。
</reflection>

<reflection>
**场景:** 用户已提供信息，系统之前提供的FAQ或指导没有解决问题，或者用户表示所提供的信息没有帮助，或在之前的尝试后再次提出相同的问题。
(例如: 在被给予一个通用的FAQ后，用户说 "I already tried that" 或 "That didn't work for my OTP issue")。
**反思:** 简单地重复相同的FAQ或一般性建议会导致用户沮丧。这表明初始信息不足或被误解了。*之前*的FAQ的 `relevance` 最初可能是 'good'，但其有效性现在是 'bad'。`guide` 必须承认之前的尝试未成功。它应该建议提出更具体的澄清性问题，以理解*为什么*之前的建议不起作用，或者寻找提供不同故障排除步骤的替代FAQ。如果没有其他相关知识存在，或者问题似乎需要更深入的技术洞察，`guide` 应建议上报以获得个性化支持。
</reflection>

<reflection>
**场景:** 用户询问需要查询私人数据的特定、个人案例、交易或投诉的状态。
(例如: "What is the status of my complaint?", "Where is my refund for transaction XYZ?", "I sent money but it's not received, what is the status?", "میری شکایت کا کیا بنا؟")
**反思:** 此类查询需要访问私人的、实时的用户数据，这些数据无法在静态的FAQ知识库中找到。系统的能力仅限于所提供的 `Knowledge FAQ`。因此，任何提供的知识对于解决这个具体的、个人的查询都是不相关的，`relevance` 必须是 'bad'。`guide` 应认识到无法使用FAQ来满足此请求。
</reflection>

<reflection>
**场景:** 用户提供了一个非常笼统、不具体的查询，如 "Help", "I have a problem", "Madad chahiye", 或 "مسئلہ ہے"。
**反思:** 这个查询缺乏具体意图。首要目标是理解用户的实际问题。直接提供客服联系方式是低效的。知识库此时不相关，因此 `relevance` 必须是 'bad'。`guide` 必须指导CSR采取**策略**来提出澄清性问题。
</reflection>

{% for ref in reflections -%}
<reflection>
{{ref.content}}
</reflection>
{% endfor %}

## 指导撰写原则 (Guidance Crafting principles)
你在 `guide` 中的主要目标是向CSR解释**策略**或**推理过程**，而不是提供他们应该使用的确切措辞。你是在指导CSR**如何思考**，而不是告诉他们**该说什么**。

## 错误示例 (直接脚本):
- guide: The user's query is too general. Ask them, Could you please tell me more about the problem you are facing? or What kind of help do you need today?
- (中文释义): guide: 用户的问题太笼统了。问他们：“您能告诉我更多关于您遇到的问题吗？”或者“今天您需要什么样的帮助？”
- 推理: 这是错误的，因为它提供了字面上的脚本，这违反了核心约束，即你**不应该**包含直接的回复话术。

## 正确示例 (策略性指导):
- guide: The user's query is too general and lacks specific details. To assist effectively, the CSR's next action should be to prompt the user for clarification. The goal is to understand the user's specific problem or request before attempting to find a solution.
- (中文释义): guide: 用户的查询过于笼统，缺乏具体细节。为了有效协助，CSR的下一步行动应该是提示用户进行澄清。目标是在尝试寻找解决方案之前，先理解用户的具体问题或请求。
- 推理: 这是正确的，因为它描述了目标（理解问题）和策略（提示澄清），而没有规定确切的措辞。

## 输出要求 (Output Requirements)
- 当使用知识进行回复时，请按以下格式输出：

{
"nextAction": "knowledge",
"relevance": enum[good, normal, bad],
"consistency": enum[good, normal, bad],
"guide": "推理过程和可行的策略"
}

## 术语 (Terms)
<terms>
{% for term in terms -%}
**术语 (term)**: {{term.title}}
**解释 (explanation)**: {{term.content}}
------
{% endfor %}
</terms>

## 知识库FAQ (Knowledge FAQ):
{% for item in recalls -%}

<knowledge>
**标题 (Title)**: {{item.title}}
**内容 (Content)**:{{item.content}}
</knowledge>

{% endfor %}
```
分析：
```
根据图中内容和提示词，这个节点是一个**知识相关性评估与策略生成器**。它的作用是在聊天机器人系统中充当一个专家判断环节，以确保对用户问题的回应是准确、相关且有效的。

以下是该节点的详细说明：

### 输入 (Input)

该节点接收多个数据作为输入，以全面理解用户请求的上下文：

1.  **USER_BOT_INPUT** (字符串): 用户在聊天机器人中输入的原始、未经处理的问题。
2.  **recalls** (对象数组): 系统根据用户问题初步检索到的相关知识库内容（如FAQs）。
3.  **language** (字符串): 系统识别出的用户输入所使用的语言。
4.  **coreQuery** (字符串): 经过大型语言模型（LLM）重构和优化的用户问题。这个版本更清晰，旨在提高知识检索和意图识别的准确性。
5.  **terms** (对象数组): 从用户原始输入中提取出的特定业务术语。

### 输出 (Output)

该节点只产生一个结构化的输出，用于指导后续的操作：

1.  **thought** (对象): 这是一个包含分析结果和指导策略的对象，其内部包含以下关键信息：
    *   **nextAction**: 建议聊天机器人下一步应该执行的动作（例如，使用知识库回答）。
    *   **relevance**: 评估检索到的知识（`recalls`）与用户问题（`coreQuery`）的相关度（分为：`good`, `normal`, `bad`）。
    *   **consistency**: 评估知识内容与用户问题具体细节的一致性。
    *   **guide**: 为人工客服（CSR）提供的、基于本次分析的行动策略和推理过程。这并非直接的回复话术，而是指导客服如何处理该问题的策略。

### 任务和作用 (Task and Role)

**核心任务 (Task):**
该节点的核心任务是执行**“知识相关性检查” (Knowledge Relevance Check)**。它利用大型语言模型（LLM）来判断当前检索到的知识库内容是否足以回答用户的问题，并据此提供相应的指导。

**作用 (Role/Function):**
这个节点扮演着一个**专家分析师**的角色。它的主要作用是在信息检索和回复生成之间增加一个关键的质量控制和决策步骤。

1.  **评估质量**: 它不仅仅是传递信息，而是主动评估检索到的知识是否准确、相关且与用户意图一致。
2.  **制定策略**: 基于评估结果，它会生成一个明确的行动指南。如果知识匹配度高，它会建议直接使用；如果知识相关性低或不明确，它会建议向用户提问以获取更多信息，或者指出知识库无法解决该问题。
3.  **赋能客服**: 它输出的 `guide` 不是简单的回复脚本，而是对情况的深入分析和处理策略，旨在帮助人工客服理解“为什么”要这么做，从而能够更智能、更灵活地服务用户，而不是机械地重复信息。

总之，这个节点通过对用户意图和知识库内容的深度分析，确保聊天机器人和人工客服能够提供高质量、有针对性的帮助，从而提升用户体验和问题解决效率。
```

## 表达（结束）
![[6E06757F-651A-461C-9F37-24BB18AF9957.png]]![[Pasted image 20251111224131.png]]
![[Pasted image 20251111224147.png]]****

根据召回内容和用户问题，生成符合要求的，对应语言的内容。

输入：
1. 召回解决方案
2. 用户改写后的问题
3. rethink节点对召回内容相关性的评估

任务：
1. sheng cha